<!DOCTYPE html>
<html>

<head>
	<title>Corona Virus Trend</title>
	<!-- Firebase JS SDK -->
	<script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-auth.js"></script>
	<script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-database.js"></script>
	<script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-analytics.js"></script>

	<!-- Date pickers -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.css" rel="stylesheet" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.js"></script>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.7.1/css/bootstrap-datepicker3.css"
		rel="stylesheet" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.7.1/js/bootstrap-datepicker.js"></script>

	<!-- Graphs with Plotly !-->
	<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

	<script>
		// Firebase configuration
		var firebaseConfig = {
			apiKey: "AIzaSyD38gEAhiQxAcoKz7_ej_qfFuNVKBM9APg",
			authDomain: "corona-trend.firebaseapp.com",
			databaseURL: "https://corona-trend.firebaseio.com",
			projectId: "corona-trend",
			storageBucket: "corona-trend.appspot.com",
			messagingSenderId: "263891468811",
			appId: "1:263891468811:web:2c7f51c89677f0e5eb7d0e",
			measurementId: "G-FW0ZTKZSLB"
		};
		// Initialize Firebase
		firebase.initializeApp(firebaseConfig);
		firebase.analytics();
	</script>
</head>

<body >
	<center><h1>Spike evolution of SARS-CoV-2</h1></center>
	<link rel="stylesheet" href="styles.css">

    <br>

    <div class="ExT1"> For details see <a href="https://www.biorxiv.org/content/10.1101/2020.10.20.347641v1/">Viral surface geometry shapes influenza and coronavirus spike evolution
    </a> </div>
    
    <br>

	<div class="ExT1"> Viral infection elicits antibodies targeting residues on the surface of glycoproteins (spikes). Because of the high-density presentation of spikes on the viral surface, not all antigenic sites are targeted equally by antibodies. We used molecular dynamics simulations to estimate antibody pressure/antibodies targeting of surface residues of the SARS-CoV-2 spike.</div>
	<!-- <br>
	<br> -->


/
		<div class="row">
			<div class="col-lg-6">
				<figure class="ExT1">
					<img src="antibodyaffinityMeasure.png" alt="Trulli" style="width:80%">
					 <figcaption class="ExT1" style="width:80%"> <b>Affinity map: antibody affinity/pressure (simulation) </b> 
						<!-- (Right) The antibody affinity (on-rate of Ab first arm binding) to the surface residues. The affinity estimated from the simulation is superimposed on the HA structure. Top view (left), side view (right). The affinity to cyan sites is high, intermediate to white sites, low for purple sites, and was the average over multiple simulations.  -->
					</figcaption>
				</figure>
	
				
			</div>
			<div class="col-lg-6">
				<figure class="ExT1">
					<img src="CoronaVirusModel_1.png" alt="Trulli" style="width:45%">
					 <figcaption style="width:45%"> <b>Antibody targeting of the spike (S protein) of SARS-CoV-2</b> 
						  <!-- mutability of the sarbecovirus subgenus spike.</b> (Left) SARS-CoV-2 spike (S) protein in its closed form (Walls et al., 2020) arranged on a sphere to create a virus model. The virus model has 65 S molecules at a density of 0.27 spikes per 100nm2 (Beniac et al., 2006). A detailed atomistic structure of the spike is coarse-grained and presented in rainbow colors (panel i). Every colored bead on the spike is a residue, representing a different S epitope (254 different possible sites on trimeric S). The antibody structure is presented as the Fc (blue bead), and two antigen binding sites (magenta beads). -->
						</figcaption>
				</figure>
			</div>
		</div>


		<div class="ExT1"> For circulating viruses to propagate, they have to evade recognition by antibodies. They do so by accumulating mutations in the spike protein. We computed the mutational pattern for the sarbecovirus subgenus spike (SARS family) spike </div>
		

	<div class="row">
		<div class="col-lg-6">
			<figure class="ExT1">
				<img src="SarbecovirusSubgenus_mut.png" alt="Trulli" style="width:80%">
				 <figcaption class="ExT1" style="width:80%"> <b>Mutability map: entropy of the sarbecovirus subgenus spike residues. Low entropy=conserve, high entropy=mutable </b> 
					<!-- (Right) The antibody affinity (on-rate of Ab first arm binding) to the surface residues. The affinity estimated from the simulation is superimposed on the HA structure. Top view (left), side view (right). The affinity to cyan sites is high, intermediate to white sites, low for purple sites, and was the average over multiple simulations. We checked for the sarbecovirus subgenus spike (SARS family) whether the mutational pattern matches the antibody pressure/affinity estimated by the model. -->
				</figcaption>
			</figure>

			
		</div>
		<div class="col-lg-5">


			<div class="ExT1" style="width:70%" id='HistFam'> </div>

			<!-- <figure class="ExT1">
				<img src="EntropySARSFam.png" alt="Trulli" style="width:40%">
				 <figcaption style="width:50%"> <b>Sequence entropy of each residue computed for the sarbecovirus subgenus spike. </b> 
					<!-- (Right) The antibody affinity (on-rate of Ab first arm binding) to the surface residues. The affinity estimated from the simulation is superimposed on the HA structure. Top view (left), side view (right). The affinity to cyan sites is high, intermediate to white sites, low for purple sites, and was the average over multiple simulations.  -->
				</figcaption>
			</figure> 
		</div>
	</div>



	<div class="ExT1"> To compare the affinity map and the mutability map we applied spectral clustering. We aggregated closeby residues to define epitope clusters.</div>

    <div class="ExT1"> How good is the model in explaining the mutability of the surface residue? </div>

	<div class="ExT1" style="width:50%" id='scatFam'> </div>
	<div class="ExT2" id='corFam'> </div>
	
	<div class="ExT1"> The correlation between the affinity map and the mutability map is 0.69 for the sarbecovirus subgenus spike. To create the affinity map we use only the surface geometry of the virus and the spike. Hence, the virus surface geometry gives rise to antibody pressure, as estimated by the model, that can explain 48% of the variability in the mutability map. </div>

	<hr>
	
	<br>	

	<center><h1> Does SARS-CoV-2 surface geometry shape its spike mutability through antibody pressure escape?</h1></center>

	<div class="ExT1"> We compared the mutability of the SARS-CoV-2 spike to the affinity map above. The spike acquires different mutations that can affect its infectivity or help it escape from antibodies. Over time its evolutionary tendencies may change. We explore its mutability map at different time periods (data from <a href="https://www.gisaid.org/">gisaid</a>). Choose time window to pick mutations acquired in this period </div>

		<div class="row">
			<div class="col-md-1"></div><div class="col-md-1"></div>
			<div class="col-md-1">
				<input type="text" class="form-control" id="datepicker">
				<button id='gobutton' > Initial point </button>

			</div>
			<div class="col-md-1">

				<input type="text" class="form-control" id="datepickerEnd">
				<button id='gobuttonEnd'> End point </button>

			</div>
        </div>

        <div class="ExT1"> Comparing the mutability map at this time window to the antibody pressure model </div>
        


     
	<div class="row">
		
		<div class="col-lg-5 col-lg-offset-1">
			<div style="width:70%" id='hist'> </div>
		</div>
		<div class="col-lg-5">
			<div style="width:70%" id='scat'> </div>
		</div>
	</div>
	
	<div class="ExT2" id='cor'> </div>

    
    <div class="ExT1"> High correlation means that the relative mutability of spike residues follows their relative accessibility to antibodies and the geometry of the viral surface, as estimated by the model. It could be indicative of escape from antibody mutations, amongst other factors (see <a href="https://www.biorxiv.org/content/10.1101/2020.10.20.347641v1/">manuscript</a>).  </div>

    <div class="ExT1"> Go to <a href="https://github.com/amitaiassaf/GeometryGlycoproteinEvolution/">repository</a> </div>

    <div class="ExT1"> Go to <a href="https://amitaiassaf.github.io/">website</a> </div>

	<script>
		var datePickerElement = $("#datepicker").datepicker({
			format: "mm-yyyy",
			viewMode: "months",
			minViewMode: "months",
			startDate: new Date(2019, 11, 1),
			endDate: new Date(2020, 09, 1)
		});
		var datePickerElementEnd = $("#datepickerEnd").datepicker({
			format: "mm-yyyy",
			viewMode: "months",
			minViewMode: "months",
			startDate: new Date(2019, 11, 1),
			endDate: new Date(2020, 09, 1)
		});
		function histogram(data,targetHist) {
			if (data) {
				var yValues = [];
				var xValues = [];
				for (var i = 0; i < data.length; i++) {
					yValues[i] = data[i].y;
					xValues[i] = data[i].x;
				}
				var dataBar = {
					x: xValues,
					y: yValues,
					type: 'bar'
				};

                layout1 = SetLayoutHist('Sequence entropy','Spike residue sequence index','Residue entropy (mutability)')

				Plotly.newPlot(targetHist, [dataBar],layout1);
			}
		}
		function scatter(data,targetScat) {
			if (data) {
				var cluster = {
					x: [],
					y: [],
					mode: 'markers',
					type: 'scatter',
					marker: {
						color: 'rgb(0, 0, 0)' // black
					},
					name: 'Cluster'
				};
				var RBD = {
					x: [],
					y: [],
					mode: 'markers',
					type: 'scatter',
					name: 'Receptor binding domain',
					marker: {
						color: 'rgb(51, 204, 51)' // green
					}
				};
				var RBM = {
					x: [],
					y: [],
					mode: 'markers',
					type: 'scatter',
					name: 'Receptor binding motif',
					marker: {
						color: 'rgb(255, 0, 0)'	// red
					}
				};
				var scatterData = data[0]; // adjust to contract glitch
				for (var i = 0; i < scatterData.length; i++) {
					if (scatterData[i].y == 0) {
						continue; // log(y)
					}
					if (scatterData[i].color == 'black') {
						cluster.x.push(scatterData[i].x);
						cluster.y.push(scatterData[i].y);
					} else if (scatterData[i].color == 'red') {
						RBM.x.push(scatterData[i].x);
						RBM.y.push(scatterData[i].y);
					} else {
						RBD.x.push(scatterData[i].x);
						RBD.y.push(scatterData[i].y);
					}
				}
				var dataScat = [cluster, RBD, RBM];
              				
				//layout = dict(updatemenus=updatemenus, title='Linear scale')
                var TitleStrScat = '';

                if(targetScat=='scatFam'){
                    TitleStrScat = 'Antibody pressure vs. mutability for sarbecovirus subgenus spike';

                } else {
                    TitleStrScat = 'Antibody pressure vs. mutability for SARS-CoV-2 spike';

                }

                layout1 = SetLayoutScat(TitleStrScat,'Antibody pressure on residues','Residues mutability')
				
				Fig1 = Plotly.newPlot(targetScat, dataScat,layout1);
				//Plotly.newPlot('scat', dataScat);
				
			}
		}
        function SetLayoutScat(TitleStr,Xstr,Ystr) {

            var layout = {
                title: {
                    text: TitleStr,
                    font: {
                    family: 'SFMono-Regular, monospace',
                    size: 15,
                    }
                  },
                xaxis: {

                  title: {
                    text: Xstr,
                    font: {
                    family: 'SFMono-Regular, monospace',
                    size: 17,
                    }
                  },
                  showline: true, 
                  zeroline: false
                },
                yaxis: {
                  title: {
                    text: Ystr,
                    font: {
                    family: 'SFMono-Regular, monospace',
                    size: 17,
                    }
                  },
                  showline: true, 
                  type: 'log',
                },
                };
                  return layout


        }
        function SetLayoutScat(TitleStr,Xstr,Ystr) {

            var layout = {
                title: {
                    text: TitleStr,
                    font: {
                    family: 'SFMono-Regular, monospace',
                    size: 15,
                    }
                  },
                xaxis: {

                  title: {
                    text: Xstr,
                    font: {
                    family: 'SFMono-Regular, monospace',
                    size: 17,
                    }
                  },
                  showline: true, 
                  zeroline: false
                },
                yaxis: {
                  title: {
                    text: Ystr,
                    font: {
                    family: 'SFMono-Regular, monospace',
                    size: 17,
                    }
                  },
                  showline: true, 
                  type: 'log',
                },
                };
                  return layout


        }
        function SetLayoutHist(TitleStr,Xstr,Ystr) {
        var layout = {
            title: {
                text: TitleStr,
                font: {
                family: 'SFMono-Regular, monospace',
                size: 15,
                }
            },
            xaxis: {

            title: {
                text: Xstr,
                font: {
                family: 'SFMono-Regular, monospace',
                size: 17,
                }
            },
            showline: true, 
            zeroline: false
            },
            yaxis: {
            title: {
                text: Ystr,
                font: {
                family: 'SFMono-Regular, monospace',
                size: 17,
                }
            },
            showline: true, 
            },
            };
            return layout
        }        
		function setCorrelationLabel(data) {
			if (data) {
				$('#cor').text(`Correlation coefficient: ${data}`);
			}
		}
		function setCorrelationLabelFam(data) {
			if (data) {
				$('#corFam').text(`Correlation coefficient: ${data}`);
			}
		}
		function getRefId(dateStr) {
			if (dateStr !== '') {
				var month = dateStr.split('-')[0];
				var year = dateStr.split('-')[1].slice(-2);
				var isJanuary = month == '01' ? true : false;
				var prevMonth = isJanuary ? '12' : month - 1;
				if (prevMonth.toString().length == 1) { prevMonth = `0${prevMonth}` }
				var prevYear = isJanuary ? year - 1 : year;
				return `D${prevYear}${prevMonth}01${year}${month}01`;
			}
		}
		function getRefIdStartEnd(dateStrStart,dateStrEnd) {
			if (dateStrStart !== '') {
				var Stmonth = dateStrStart.split('-')[0];
				var Styear = dateStrStart.split('-')[1].slice(-2);
				var isJanuary = Stmonth == '01' ? true : false;

				var Endmonth = dateStrEnd.split('-')[0];
				var Endyear = dateStrEnd.split('-')[1].slice(-2);
				
				var isDecember = Endmonth == '12' ? true : false;
				
				Endyear = '20';
								
				var NextMonth = isDecember ? '01' : String(Number(Endmonth) + 1);
				
				if (NextMonth.toString().length == 1) { NextMonth = `0${NextMonth}` }

				//return `D${Styear}${Stmonth}01${Endyear}${Endmonth}01`;
				return `D${Styear}${Stmonth}01${Endyear}${NextMonth}01`;
			}
		}
		function paintWithRefId(refId) {
			firebase.database().ref(refId).once('value').then(function (snapshot) {
				var data = snapshot.val();
				console.log(data);
				if (data) {
					var targetHist = 'hist';
					histogram(data.hist,targetHist);
					var targetScat = 'scat';
					scatter(data.scatter,targetScat);
					var targetCor = 'cor';
					setCorrelationLabel(data.CC);
				}
			});
		}
		function paintFamWithRefId(refId) {
			firebase.database().ref(refId).once('value').then(function (snapshot) {
				var data = snapshot.val();
				console.log(data);
				if (data) {
					var targetScat = 'scatFam';
					var targetHist = 'HistFam';
					histogram(data.hist,targetHist);
					scatter(data.scatter,targetScat);
					setCorrelationLabelFam(data.CC);
				}
			});
		}

		// on page load

        // load sarbecovirus subgenus family spike entropy and scatter
		datePickerElement.val('01-2002'); // 
		datePickerElementEnd.val('01-2019');
		var refSARSFam = 'D020101190101';
		
		 paintFamWithRefId(refSARSFam);

		datePickerElement.val('07-2020'); // show Oct 2020 by default
		datePickerElementEnd.val('09-2020'); // 
		//var refId = getRefId(datePickerElement.val());
		//var refIdStart = getRefId(datePickerElement.val());
		var refIdEnd = getRefIdStartEnd(datePickerElement.val(),datePickerElementEnd.val());

		//paintWithRefId(refId);
		paintWithRefId(refIdEnd);
		

		$('#gobutton').click(function () {
			//var refId = getRefId(datePickerElement.val());
			var refId = getRefIdStartEnd(datePickerElement.val(),datePickerElementEnd.val());
			if (refId) {
				paintWithRefId(refId);
			} else {
				alert("Please choose a month");
			}
		});
		$('#gobuttonEnd').click(function () {
			//var refId = getRefId(datePickerElementEnd.val());
			var refId = getRefIdStartEnd(datePickerElement.val(),datePickerElementEnd.val());
			if (refId) {
				paintWithRefId(refId);
			} else {
				alert("Please choose a month");
			}
		});
	</script>
</body>
</html>
