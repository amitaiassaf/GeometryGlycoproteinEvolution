<!DOCTYPE html>
<html>

<head>
	<title>Corona Virus Trend</title>
	<!-- Firebase JS SDK -->
	<script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-auth.js"></script>
	<script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-database.js"></script>
	<script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-analytics.js"></script>

	<!-- Date pickers -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.css" rel="stylesheet" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.js"></script>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.7.1/css/bootstrap-datepicker3.css"
		rel="stylesheet" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.7.1/js/bootstrap-datepicker.js"></script>

	<!-- Graphs with Plotly !-->
	<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

	<script>
		// Firebase configuration
		var firebaseConfig = {
			apiKey: "AIzaSyD38gEAhiQxAcoKz7_ej_qfFuNVKBM9APg",
			authDomain: "corona-trend.firebaseapp.com",
			databaseURL: "https://corona-trend.firebaseio.com",
			projectId: "corona-trend",
			storageBucket: "corona-trend.appspot.com",
			messagingSenderId: "263891468811",
			appId: "1:263891468811:web:2c7f51c89677f0e5eb7d0e",
			measurementId: "G-FW0ZTKZSLB"
		};
		// Initialize Firebase
		firebase.initializeApp(firebaseConfig);
		firebase.analytics();
	</script>
</head>

<body >
	<center><h1>Spike evolution of SARS-CoV-2</h1></center>
	<link rel="stylesheet" href="styles.css">

	<div class="ExT1"> Viral infection elicits a humoral response and the production of antibodies with near-limitless diversity, which target residues on the surface of glycoproteins (spikes). Because of the high-density presentation of spikes on the viral surface, not all antigenic sites are targeted equally by antibodies. We used molecular dynamics simulation to estimate the ability of antibodies to target different surface residues of the SARS-CoV-2 spike.</div>
	<!-- <br>
	<br> -->



		<div class="row">
			<div class="col-lg-6">
				<figure class="ExT1">
					<img src="antibodyaffinityMeasure.png" alt="Trulli" style="width:80%">
					 <figcaption class="ExT1" style="width:80%"> <b>Affinity map: antibody affinity (on-rate of the antiboy) or antibody pressure estimated from the simulation is superimposed on the spike structure. </b> 
						<!-- (Right) The antibody affinity (on-rate of Ab first arm binding) to the surface residues. The affinity estimated from the simulation is superimposed on the HA structure. Top view (left), side view (right). The affinity to cyan sites is high, intermediate to white sites, low for purple sites, and was the average over multiple simulations.  -->
					</figcaption>
				</figure>
	
				
			</div>
			<div class="col-lg-6">
				<figure class="ExT1">
					<img src="CoronaVirusModel_1.png" alt="Trulli" style="width:45%">
					 <figcaption style="width:45%"> <b>Antibody targeting of the spike (S protein) of SARS-CoV-2</b> 
						  <!-- mutability of the sarbecovirus subgenus spike.</b> (Left) SARS-CoV-2 spike (S) protein in its closed form (Walls et al., 2020) arranged on a sphere to create a virus model. The virus model has 65 S molecules at a density of 0.27 spikes per 100nm2 (Beniac et al., 2006). A detailed atomistic structure of the spike is coarse-grained and presented in rainbow colors (panel i). Every colored bead on the spike is a residue, representing a different S epitope (254 different possible sites on trimeric S). The antibody structure is presented as the Fc (blue bead), and two antigen binding sites (magenta beads). -->
						</figcaption>
				</figure>
			</div>
		</div>


		<div class="ExT1"> For circulating viruses to propagate, they have to evade neutralization and recognition by antibodies and do so, by accumulating mutations at their spikes. We checked for the sarbecovirus subgenus spike (SARS family) whether the mutational pattern matches the antibody pressure/affinity estimated by the model.</div>
		

	<div class="row">
		<div class="col-lg-5">
			<figure class="ExT1">
				<img src="SarbecovirusSubgenus_mut.png" alt="Trulli" style="width:80%">
				 <figcaption class="ExT1" style="width:80%"> <b>Mutability map: entropy of the sarbecovirus subgenus residues superimposed on the spike structure. </b> 
					<!-- (Right) The antibody affinity (on-rate of Ab first arm binding) to the surface residues. The affinity estimated from the simulation is superimposed on the HA structure. Top view (left), side view (right). The affinity to cyan sites is high, intermediate to white sites, low for purple sites, and was the average over multiple simulations.  -->
				</figcaption>
			</figure>

			
		</div>
		<div class="col-lg-5">


			<div class="ExT1" style="width:70%" id='HistFam'> </div>

			<!-- <figure class="ExT1">
				<img src="EntropySARSFam.png" alt="Trulli" style="width:40%">
				 <figcaption style="width:50%"> <b>Sequence entropy of each residue computed for the sarbecovirus subgenus spike. </b> 
					<!-- (Right) The antibody affinity (on-rate of Ab first arm binding) to the surface residues. The affinity estimated from the simulation is superimposed on the HA structure. Top view (left), side view (right). The affinity to cyan sites is high, intermediate to white sites, low for purple sites, and was the average over multiple simulations.  -->
				</figcaption>
			</figure> 
		</div>
	</div>



	<div class="ExT1"> To compare the affinity map and the mutability map we applied spectral clustering. We aggregate residues to epitope clusters. The scatter plot shows how well the model does in explaining the mutability of the surface residue. </div>


	<div class="ExT1" style="width:30%" id='scatFam'> </div>
	<div class="ExT2" id='corFam'> </div>
	
	<div class="ExT1"> The correlation between the affinity map and the mutability map is 0.69 for the sarbecovirus subgenus spike. To create the affinity map and estimate antibody pressure on a residue, we use only the surface geometry of the virus and the spike. Hence, the virus surface geometry gives rise to antibody pressure, as estimated by the model, that can explain 48% of the variability in the mutability map of the sarbecovirus subgenus spike. </div>

	<hr>
	
	<br>	

	<center><h1> Does the mutational pattern of SARS-CoV-2 follow the simulatons?</h1></center>
	

	<div class="ExT1"> We compared the mutability of the SARS-CoV-2 spike to the affinity map. Because over time the mutational patterns of the spike evolution can change, we explore its mutability map at different time periods. Choose below the initial time-point and the end time-point over which you want to compare the mutability map to the model. A high correlation value means that the mutability pattern of the spike follows antibody pressure as estimated by the model and could be indicative of escape from antibody mutations, amongst other factors (see manuscript).  </div>

	
		<div class="row">
			<div class="col-md-1"></div><div class="col-md-1"></div>
			<div class="col-md-1">
				<input type="text" class="form-control" id="datepicker">
				<button id='gobutton' > Initial point </button>

			</div>
			<div class="col-md-1">

				<input type="text" class="form-control" id="datepickerEnd">
				<button id='gobuttonEnd'> End point </button>

			</div>
		</div>
	
	<div class="row">
		
		<div class="col-lg-5 col-lg-offset-1">
			<div style="width:70%" id='hist'> </div>
		</div>
		<div class="col-lg-5">
			<div style="width:70%" id='scat'> </div>
		</div>
	</div>
	
	<div class="ExT2" id='cor'> </div>

	

	<script>
		var datePickerElement = $("#datepicker").datepicker({
			format: "mm-yyyy",
			viewMode: "months",
			minViewMode: "months",
			startDate: new Date(2019, 11, 1),
			endDate: new Date(2020, 09, 1)
		});
		var datePickerElementEnd = $("#datepickerEnd").datepicker({
			format: "mm-yyyy",
			viewMode: "months",
			minViewMode: "months",
			startDate: new Date(2019, 11, 1),
			endDate: new Date(2020, 09, 1)
		});
		function histogram(data,targetHist) {
			if (data) {
				var yValues = [];
				var xValues = [];
				for (var i = 0; i < data.length; i++) {
					yValues[i] = data[i].y;
					xValues[i] = data[i].x;
				}
				var dataBar = {
					x: xValues,
					y: yValues,
					type: 'bar'
				};
				var layout = {
                title: 'Sequence entropy',
                xaxis: {
                  title: 'S residue sequence index',
                  showgrid: false,
                  zeroline: false
                },
                yaxis: {
                  title: 'Residue entropy (mutability)',
                  showline: true
                }
              	};
				Plotly.newPlot(targetHist, [dataBar],layout);
			}
		}
		function scatter(data,targetScat) {
			if (data) {
				var cluster = {
					x: [],
					y: [],
					mode: 'markers',
					type: 'scatter',
					marker: {
						color: 'rgb(0, 0, 0)' // black
					},
					name: 'cluster'
				};
				var RBD = {
					x: [],
					y: [],
					mode: 'markers',
					type: 'scatter',
					name: 'RBD',
					marker: {
						color: 'rgb(51, 204, 51)' // green
					}
				};
				var RBM = {
					x: [],
					y: [],
					mode: 'markers',
					type: 'scatter',
					name: 'RBM',
					marker: {
						color: 'rgb(255, 0, 0)'	// red
					}
				};
				var scatterData = data[0]; // adjust to contract glitch
				for (var i = 0; i < scatterData.length; i++) {
					if (scatterData[i].y == 0) {
						continue; // log(y)
					}
					if (scatterData[i].color == 'black') {
						cluster.x.push(scatterData[i].x);
						cluster.y.push(scatterData[i].y);
					} else if (scatterData[i].color == 'red') {
						RBM.x.push(scatterData[i].x);
						RBM.y.push(scatterData[i].y);
					} else {
						RBD.x.push(scatterData[i].x);
						RBD.y.push(scatterData[i].y);
					}
				}
				var dataScat = [cluster, RBD, RBM];
              				
              	var layout = {
                title: 'Antibody pressure vs. mutability for SARS-CoV-2 spike (S protein)',
                xaxis: {
                  title: 'Antibody pressure on residues from computational model',
                  showgrid: false,
                  zeroline: false
                },
                yaxis: {
                  title: 'Residues mutability estimated from sequences',
                  showline: true,
				  type: 'log',
                }
              	};
				//layout = dict(updatemenus=updatemenus, title='Linear scale')

				//Fig1 = Plotly.newPlot('scat', dataScat,layout);
				//T = '${targetScat}';
				Fig1 = Plotly.newPlot(targetScat, dataScat,layout);
				//Plotly.newPlot('scat', dataScat);
				
			}
		}
		function setCorrelationLabel(data) {
			if (data) {
				$('#cor').text(`Correlation coefficient: ${data}`);
			}
		}
		function setCorrelationLabelFam(data) {
			if (data) {
				$('#corFam').text(`Correlation coefficient: ${data}`);
			}
		}
		function getRefId(dateStr) {
			if (dateStr !== '') {
				var month = dateStr.split('-')[0];
				var year = dateStr.split('-')[1].slice(-2);
				var isJanuary = month == '01' ? true : false;
				var prevMonth = isJanuary ? '12' : month - 1;
				if (prevMonth.toString().length == 1) { prevMonth = `0${prevMonth}` }
				var prevYear = isJanuary ? year - 1 : year;
				return `D${prevYear}${prevMonth}01${year}${month}01`;
			}
		}
		function getRefIdStartEnd(dateStrStart,dateStrEnd) {
			if (dateStrStart !== '') {
				var Stmonth = dateStrStart.split('-')[0];
				var Styear = dateStrStart.split('-')[1].slice(-2);
				var isJanuary = Stmonth == '01' ? true : false;

				var Endmonth = dateStrEnd.split('-')[0];
				var Endyear = dateStrEnd.split('-')[1].slice(-2);
				//var isJanuary = Endmonth == '01' ? true : false;
				
				var isDecember = Endmonth == '12' ? true : false;
				
				//var is2019 = Endyear == '2019' ? true : false;


				//var Endmonth1 = isDecember ? Endmonth : Endmonth + 1;
				//var prevMonth = isJanuary ? '12' : month - 1;
				Endyear = '20';
				//var NextMonth = isJanuary ? '12' : Endmonth + 1;
				//var NextMonth = Endmonth;
				//var NextMonth = isJanuary ? '12' : Endmonth - 1;
				//var NextMonth = isJanuary ? '12' : Endmonth - 1;
				//if (NextMonth.toString().length == 1) { NextMonth = `0${NextMonth}` }

				//var NextMonth = isJanuary ? '12' : Endmonth;
				//Var NextMonthNum = Number(NextMonth);

				//var a = (NextMonth)+1;
				//var b = (a);
				//NextMonth = b;

				//var a = Number(NextMonth)+1;
				//var b = String(a);
				//NextMonth = b;

				//if (NextMonth.toString().length == 1) { NextMonth = `0${NextMonth}` }
				//Endmonth = Endmonth + 1;
				//if (Endmonth.toString().length == 1) { Endmonth = `0${Endmonth}` }

				//Endyear = is2019 ? '2020' : Endmonth + 1;

				//var prevMonth = isJanuary ? '12' : month - 1;
				//if (prevMonth.toString().length == 1) { prevMonth = `0${prevMonth}` }
				//var prevYear = isJanuary ? year - 1 : year;
				//return `D${prevYear}${prevMonth}01${year}${month}01`;
				//return `D${Styear}${Stmonth}01${Endyear}${Endmonth}01`;
				return `D${Styear}${Stmonth}01${Endyear}${Endmonth}01`;
			}
		}
		function paintWithRefId(refId) {
			firebase.database().ref(refId).once('value').then(function (snapshot) {
				var data = snapshot.val();
				console.log(data);
				if (data) {
					var targetHist = 'hist';
					histogram(data.hist,targetHist);
					var targetScat = 'scat';
					scatter(data.scatter,targetScat);
					var targetCor = 'cor';
					setCorrelationLabel(data.CC);
				}
			});
		}
		function paintFamWithRefId(refId) {
			firebase.database().ref(refId).once('value').then(function (snapshot) {
				var data = snapshot.val();
				console.log(data);
				if (data) {
					var targetScat = 'scatFam';
					var targetHist = 'HistFam';
					histogram(data.hist,targetHist);
					scatter(data.scatter,targetScat);
					setCorrelationLabelFam(data.CC);
				}
			});
		}

		// on page load

// Load family entropy and scatter

		datePickerElement.val('01-2002'); // show Dec 2019 by default
		datePickerElementEnd.val('01-2019');
		//D020101190101
		//var refSARSFam = getRefIdStartEnd(datePickerElement.val(),datePickerElementEnd.val());
		var refSARSFam = 'D020101190101';
		
		 paintFamWithRefId(refSARSFam);

		datePickerElement.val('04-2020'); // show Oct 2020 by default
		datePickerElementEnd.val('07-2020'); // 
		//var refId = getRefId(datePickerElement.val());
		//var refIdStart = getRefId(datePickerElement.val());
		var refIdEnd = getRefIdStartEnd(datePickerElement.val(),datePickerElementEnd.val());

		//paintWithRefId(refId);
		paintWithRefId(refIdEnd);
		

		$('#gobutton').click(function () {
			//var refId = getRefId(datePickerElement.val());
			var refId = getRefIdStartEnd(datePickerElement.val(),datePickerElementEnd.val());
			if (refId) {
				paintWithRefId(refId);
			} else {
				alert("Please choose a month");
			}
		});
		$('#gobuttonEnd').click(function () {
			//var refId = getRefId(datePickerElementEnd.val());
			var refId = getRefIdStartEnd(datePickerElement.val(),datePickerElementEnd.val());
			if (refId) {
				paintWithRefId(refId);
			} else {
				alert("Please choose a month");
			}
		});
	</script>
</body>
</html>
